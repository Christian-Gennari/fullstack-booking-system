# App Sequence Diagram (Who talks to who?)

```mermaid
sequenceDiagram
    autonumber
    participant User as ğŸ‘¤ User
    participant Frontend as ğŸ–¥ï¸ Frontend (public/js)
    participant Auth as ğŸ›¡ï¸ Authentication (The Bouncer)
    participant AuthZ as ğŸ” Authorization (The Gatekeeper)
    participant Controller as ğŸ¤µ Controller (The Waiter)
    participant Repo as ğŸ“š Repository (The Librarian)
    participant DB as ğŸ’½ Database (SQLite)

    Note right of Auth: ğŸ›¡ï¸ Bearer Token Auth: The Bouncer validates the token<br/>against the sessions table and attaches the user to the request.
    Note right of AuthZ: ğŸ” Role Check: Ensures the authenticated user has the right role.<br/>Returns 403 Forbidden on insufficient permissions.

    Note over User, Frontend: Phase 1: The Order
    User->>Frontend: Clicks "Book Room"
    Frontend->>Frontend: Retrieves token from localStorage<br/>(Stored after successful login)
    Frontend->>Auth: POST /api/bookings Headers: { Authorization: "Bearer abc123..." }
    Frontend->>Auth: DELETE /api/auth/logout Headers: { Authorization: "Bearer abc123..." } // Added logout functionality
    Note over User, Frontend: Phase 2: Logout
    User->>Frontend: Clicks "Logout"

    Note over Auth, Controller: Phase 2: Authentication
    Auth->>DB: SELECT * FROM sessions WHERE token = "..." AND expires_at > NOW
    alt Invalid or Expired Token?
        Auth-->>Frontend: 401 Unauthorized â›”
    else Valid Token
        Auth->>DB: SELECT * FROM users WHERE id = session.user_id
        Auth->>AuthZ: next() (User attached to req.user) âœ…
    end

    Note over AuthZ, Controller: Phase 3: Authorization
    alt Role Allowed?
        AuthZ->>Controller: next() âœ…
    else Insufficient Role
        AuthZ-->>Frontend: 403 Forbidden â›”
    end

    Note over Controller, DB: Phase 4: Processing
    Controller->>Repo: createBooking(roomId, userId...)
    Repo->>DB: INSERT INTO bookings...
    DB-->>Repo: Success (Row ID: 42)
    Repo-->>Controller: Returns Result

    Note over Controller, User: Phase 5: Response
    Controller-->>Frontend: 201 Created (JSON)
    Frontend->>User: Alert("Booking Confirmed! ğŸ‰")
    Frontend->>Frontend: Reloads Room List
```

# The Architecture Diagram (Physical Structure)

```mermaid
graph TD
    subgraph Client ["ğŸ½ï¸ Dining Room (Frontend)"]
        User((ğŸ‘¤ User))
        Browser["ğŸ–¥ï¸ Browser / public/"]
        LS[("Token / localStorage")]
    end

    subgraph Server ["The Kitchen (Backend)"]
        App["âš™ï¸ App.js / Server.js"]

        subgraph Logic ["The Staff"]
            MW["ğŸ›¡ï¸ Middleware"]
            AuthB["Authentication (Bouncer)"]
            Gate["Authorization (Gatekeeper)"]
            Route["ğŸ“œ Routes"]
            Ctrl["ğŸ¤µ Controllers"]
            Repo["ğŸ“š Repositories"]
            Utils["ğŸ§° Utils"]
        end

        DB[("ğŸ’½ SQLite Database")]
    end

    %% Connections
    User -- Clicks Button --> Browser
    Browser -- 1. Reads Token --> LS
    Browser -- 2. Sends HTTP Request with Bearer Token --> App

    App --> Route
    Route --> AuthB
    AuthB -- Validates Token in Sessions Table --> DB
    AuthB -- If Valid --> Gate
    Gate -- If Role Allowed --> Ctrl

    Ctrl -- Asks for Data --> Repo
    Repo -- SQL Query --> DB

    DB -- Raw Data --> Repo
    Repo -- Data --> Ctrl
    Ctrl -- JSON Response --> Browser
    Browser -- Updates UI --> User
```
